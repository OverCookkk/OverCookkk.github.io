---
title: c++编译链接全过程
tags: [c++]      #添加的标签
categories: 
  - c++
#description: 
cover: https://raw.githubusercontent.com/OverCookkk/PicBed/master/blog_cover_images/00746-1935579314.png
---

从写一个简单的“hello world！”到完成一个大型程序，当程序从编辑完成到执行成功都会经过5个步骤，分别是预处理（Prepressing）、编译（Compilation）、汇编（Assembly）、链接（Linking）和执行（Executing）。



## 预处理

预处理器，进行预处理。预处理过程主要处理那些源代码文件以“#”开始的预编译指令。比如“#include”、“#define”和条件预编译指令，如“#if”、“#ifdef”等。预处理时，将所有的“#define”删除，展开所有的宏定义，并且替换掉“#include”。

预编译程序所完成的基本上是对源程序的“**替代**”工作。经过此种替代，生成一个没有宏定义、没有条件编译指令、没有特殊符号的输出文件。这个文件的含义同没有经过预处理的源文件是相同的，但内容有所不同，经过预编译后产生完整的源文件，将此文件作为编译程序的输入而被翻译成为机器指令。



## 编译

经过预编译得到的输出文件中，只有常量；如数字、字符串、变量的定义，以及C语言的关键字等。编译过程就是用编译器把预处理完的文件进行一系列的<u>词法分析、语法分析、语义分析以及优化后产生相应的汇编代码文件</u>，这个过程是整个程序构建的核心部分，也是最复杂的部分之一。



## 汇编

汇编实际上指把汇编语言代码翻译成目标机器指令的过程。汇编器的编译过程相对于编译器来讲比较简单，它没有复杂的语法，也没有语义，也不需要做指令优化，只是根据汇编指令和机器指令的对照表一一翻译。对于被翻译系统处理的每一个语言源程序，都将最终经过这一处理而得到相应的目标文件。目标程序一般以.obj或.o作为后缀，这具体看操作系统，<u>如Windows是下是.obj目标文件，Linux下是.o目标文件</u>。目标文件中所存放的也就是与源程序等效的目标机器语言代码。有时候我们也将预编译、编译和汇编统称为编译。



## 链接

预编译、编译和汇编是对源文件分别进行的，每个源文件都产生一个目标文件。但由汇编程序生成的目标文件并不能立即就被执行，因为各个源文件之间可能是有相互联系的，例如，某个源文件中的函数可能引用了另一个源文件中定义的某个符号(如变量或者函数调用等)；在程序中可能调用了某个库文件中的函数，等等。

所有的这些问题都需要经链接解决，即将源程序产生的多个目标文件链接为一个整体。即通过系统提供的“连接程序(linker)”将一个程序的所有目标程序和系统的库文件以及系统提供的其他信息连接起来，最终形成一个可执行的二进制文件，它的后缀是.exe，此时产生了完整的执行文件。

根据指定的库函数的不同，链接处理可分为两种：

　　(1)静态链接：在这种链接方式下，函数的代码将从其所在地静态链接库中被<u>拷贝到最终的可执行程序中</u>。这样该程序在被执行时这些代码将被装入到该进程的虚拟地址空间中。静态链接库实际上是一个目标文件的集合，其中的每个文件含有库中的一个或者一组相关函数的代码。Windows是下是.lib文件，Linux下是.a文件。

　　(2)动态链接：此种方式下，函数的代码被放到称作是动态链接库或共享对象的某个目标文件中。链接程序此时所作的只是在最终的可执行程序中<u>记录下共享对象的名字以及其它少量的登记信息</u>。在此可执行文件被执行时，动态链接库的全部内容将被映射到运行时相应进程的虚地址空间。动态链接程序将根据可执行程序中记录的信息找到相应的函数代码。Windows是下是.dll文件，Linux下是.so文件。

　　对于可执行文件中的函数调用，可分别采用动态链接或静态链接的方法。使用动态链接能够使最终的可执行文件比较短小，并且当共享对象被多个进程使用时能节约一些内存，因为在内存中只需要保存一份此共享对象的代码。但并不是使用动态链接就一定比使用静态链接要优越。 

